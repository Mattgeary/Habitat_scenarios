gc()
output.2 <- paste(getwd(), "Scenario_2", sep="/")

#pres.abs.a <- numeric(models)
#pres.abs.b <- numeric(models)
#pres.abs.c <- numeric(models)
#pres.abs.d <- numeric(models)
#pres.abs.e <- numeric(models)

pres.abs <- numeric(models)

for(j in 1:models){

# Read in potential area layer

potential <- raster(paste(getwd(), "Binary/bin_3.asc", sep="/"),  crs=BNG)

rcl <- matrix(c(-1,0.7,NA,0.8,1.2,0), nrow=2, ncol=3, byrow=T)
potential.0 <- reclass(potential, rcl)

rnd.pts <- randomPoints(potential.0, 10)
rnd.pts <- as.data.frame(rnd.pts)
potential.pts <- rasterize(rnd.pts, potential, background=0)
potential.pts <- potential.0 + potential.pts
projection(potential.pts) <- BNG
rm(potential)

iterations <- 50
p.trans <- 0.25
new.hab <- f.Exp(potential.pts, potential.pts, p.trans)
for(i in 1:iterations){
	if(cellStats(new.hab, sum) <= 6479.9) new.hab <- f.Exp(new.hab, potential.pts, p.trans)
	else new.hab <- new.hab
    }

dir.create(paste(getwd(), "/Scenario_2/run_", j, sep=""))

rcl.na <- matrix(c(NA, NA, 0), nrow=1, ncol=3, byrow=T)
new.hab <- reclass(new.hab, rcl.na)

hab.2 <- raster(paste(getwd(), "Binary/bin_2.asc", sep="/"))
hab.2 <- hab.2 + new.hab
hab.2 <- reclass(hab.2, rcl.na)
projection(hab.2) <- BNG
hab.2 <- focal(hab.2, w=17, mean, na.rm=T, pad=T)
setwd(output.2)
writeRaster(hab.2, paste(paste(getwd(), "/run_", j, sep=""), "/hab_2.asc", sep=""), overwrite=T)
rm(hab.2)
setwd(work)

hab.3 <- raster(paste(getwd(), "Binary/bin_3.asc", sep="/"))
hab.3 <- hab.3 - new.hab
hab.3 <- reclass(hab.3, rcl.na)
projection(hab.3) <- BNG
hab.3 <- focal(hab.3, w=17, mean, na.rm=T, pad=T)
setwd(output.2)
writeRaster(hab.3, paste(paste(getwd(), "/run_", j, sep=""), "/hab_3.asc", sep=""), overwrite=T)
rm(hab.3)
setwd(work)

gc()
env.l.new <- stack(raster(paste(getwd(), "Proportion/hab_1.asc", sep="/"), crs=BNG), raster(paste(getwd(), paste("Scenario_2/run_", j, sep=""), "hab_2.asc", sep="/"), crs=BNG), raster(paste(getwd(), paste("Scenario_2/run_", j, sep=""), "hab_3.asc", sep="/"), crs=BNG), raster(paste(getwd(), "Proportion/hab_4.asc", sep="/"), crs=BNG), raster(paste(getwd(), "Proportion/hab_5.asc", sep="/"), crs=BNG), raster(paste(getwd(), "Proportion/hab_6.asc", sep="/"), crs=BNG), raster("studyareadem.asc", crs=BNG))

#pred.a <- predict(max_base.a, env.l.new)
#pred.b <- predict(max_base.b, env.l.new)
#pred.c <- predict(max_base.c, env.l.new)
#pred.d <- predict(max_base.d, env.l.new)
#pred.e <- predict(max_base.e, env.l.new)

pred <- predict(max_base, env.l.new)

writeRaster(pred, filename=(paste(getwd(), "Scenario_2", paste("pred_map", j, ".grd", sep= ""), sep="/")), overwrite=T)
rm(env.l.new)
gc()

#pa <- reclass(pred.a, rcl.a)
#pres.abs.a[j] <- cellStats(pa, mean)
#pa <- reclass(pred.b, rcl.b)
#pres.abs.b[j] <- cellStats(pa, mean)
#pa <- reclass(pred.c, rcl.c)
#pres.abs.c[j] <- cellStats(pa, mean)
#pa <- reclass(pred.d, rcl.d)
#pres.abs.d[j] <- cellStats(pa, mean)
#pa <- reclass(pred.e, rcl.e)
#pres.abs.e[j] <- cellStats(pa, mean)

#rm(pred.a, pred.b, pred.c, pred.d, pred.e)

pa <- reclass(pred, rcl.m)
pres.abs[j] <- cellStats(pa, mean)

}


#write.csv(pres.abs.a, "goodhab_a.csv", row.names=F)
#write.csv(pres.abs.b, "goodhab_b.csv", row.names=F)
#write.csv(pres.abs.c, "goodhab_c.csv", row.names=F)
#write.csv(pres.abs.d, "goodhab_d.csv", row.names=F)
#write.csv(pres.abs.e, "goodhab_e.csv", row.names=F)
#rm(pres.abs.a,pres.abs.b,pres.abs.c,pres.abs.d,pres.abs.e, rcl, pred.map, pa,env.l.base, base.map, BK.pres)

write.csv(pres.abs, "Scenario_2.csv")
